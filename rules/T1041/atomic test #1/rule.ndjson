{"rule_id":"apt-001-reconnaissance","name":"APT Reconnaissance - Suspicious DNS Queries","description":"Detects DNS queries to known C2 domains or suspicious patterns indicative of APT reconnaissance phase","severity":"high","risk_score":75,"type":"query","query":"event.code:22 AND winlog.event_data.QueryStatus:0 AND (winlog.event_data.QueryName:(*pastebin* OR *cloudfront* OR *githubusercontent* OR *ngrok* OR *duckdns* OR *no-ip* OR *ddns*) OR winlog.event_data.QueryResults:*)","language":"kuery","filters":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0043","name":"Reconnaissance","reference":"https://attack.mitre.org/tactics/TA0043/"},"technique":[{"id":"T1592","name":"Gather Victim Host Information","reference":"https://attack.mitre.org/techniques/T1592/"}]}],"tags":["APT","Reconnaissance","DNS","Sysmon","Event ID 22"],"enabled":true,"interval":"1m","from":"now-2m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-002-initial-access","name":"APT Initial Access - PowerShell DNS Query to External Domain","description":"Detects PowerShell making DNS queries to external domains, potential initial access or payload download","severity":"high","risk_score":80,"type":"query","query":"event.code:22 AND winlog.event_data.Image:*powershell.exe AND winlog.event_data.QueryStatus:0 AND NOT winlog.event_data.QueryName:(*.microsoft.com OR *.windows.com OR *.windowsupdate.com)","language":"kuery","filters":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0001","name":"Initial Access","reference":"https://attack.mitre.org/tactics/TA0001/"},"technique":[{"id":"T1566","name":"Phishing","reference":"https://attack.mitre.org/techniques/T1566/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059.001","name":"PowerShell","reference":"https://attack.mitre.org/techniques/T1059/001/"}]}],"tags":["APT","Initial Access","PowerShell","DNS","Sysmon"],"enabled":true,"interval":"1m","from":"now-2m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-003-c2-communication","name":"APT Command and Control - Suspicious DNS Beaconing Pattern","description":"Detects repetitive DNS queries that may indicate C2 beaconing behavior characteristic of APT operations","severity":"critical","risk_score":90,"type":"threshold","query":"event.code:22 AND winlog.event_data.QueryStatus:0","language":"kuery","filters":[],"threshold":{"field":["winlog.event_data.QueryName","winlog.event_data.ProcessId"],"value":10,"cardinality":[{"field":"winlog.event_data.QueryResults","value":1}]},"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1071","name":"Application Layer Protocol","reference":"https://attack.mitre.org/techniques/T1071/"},{"id":"T1071.004","name":"DNS","reference":"https://attack.mitre.org/techniques/T1071/004/"}]}],"tags":["APT","Command and Control","DNS Beaconing","Sysmon"],"enabled":true,"interval":"1m","from":"now-15m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-004-exfiltration","name":"APT Exfiltration - DNS Tunneling Detection","description":"Detects potential DNS tunneling used for data exfiltration by APT groups","severity":"critical","risk_score":95,"type":"query","query":"event.code:22 AND winlog.event_data.QueryStatus:0 AND (winlog.event_data.QueryName.length > 60 OR winlog.event_data.QueryName:*.*.*.*.*.*.*.*) AND NOT winlog.event_data.QueryName:(*.microsoft.com OR *.windows.com OR *.google.com OR *.amazon.com)","language":"kuery","filters":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"},"technique":[{"id":"T1048","name":"Exfiltration Over Alternative Protocol","reference":"https://attack.mitre.org/techniques/T1048/"},{"id":"T1048.003","name":"Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol","reference":"https://attack.mitre.org/techniques/T1048/003/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1071.004","name":"DNS","reference":"https://attack.mitre.org/techniques/T1071/004/"}]}],"tags":["APT","Exfiltration","DNS Tunneling","Sysmon"],"enabled":true,"interval":"1m","from":"now-2m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-005-persistence","name":"APT Persistence - Suspicious Service DNS Resolution","description":"Detects DNS queries from system services that may indicate persistence mechanisms","severity":"medium","risk_score":60,"type":"query","query":"event.code:22 AND winlog.user.name:SYSTEM AND winlog.event_data.QueryStatus:0 AND NOT winlog.event_data.Image:(*svchost.exe OR *MsMpEng.exe OR *wuauclt.exe OR *TrustedInstaller.exe)","language":"kuery","filters":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1543","name":"Create or Modify System Process","reference":"https://attack.mitre.org/techniques/T1543/"},{"id":"T1543.003","name":"Windows Service","reference":"https://attack.mitre.org/techniques/T1543/003/"}]}],"tags":["APT","Persistence","System Service","DNS","Sysmon"],"enabled":true,"interval":"1m","from":"now-2m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-006-lateral-movement","name":"APT Lateral Movement - Remote Host DNS Enumeration","description":"Detects DNS queries for internal domain enumeration indicative of lateral movement preparation","severity":"high","risk_score":70,"type":"query","query":"event.code:22 AND winlog.event_data.QueryStatus:0 AND winlog.event_data.QueryName:(*._ldap.* OR *._kerberos.* OR *._gc.* OR *._msdcs.* OR *._sites.*)","language":"kuery","filters":[],"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0007","name":"Discovery","reference":"https://attack.mitre.org/tactics/TA0007/"},"technique":[{"id":"T1018","name":"Remote System Discovery","reference":"https://attack.mitre.org/techniques/T1018/"}]}],"tags":["APT","Lateral Movement","DNS Enumeration","Active Directory","Sysmon"],"enabled":true,"interval":"1m","from":"now-2m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}
{"rule_id":"apt-007-credential-access","name":"APT Credential Access - Password Spray DNS Pattern","description":"Detects DNS query patterns consistent with password spraying attacks","severity":"high","risk_score":75,"type":"threshold","query":"event.code:22 AND winlog.event_data.QueryStatus:0 AND winlog.event_data.Image:*powershell.exe","language":"kuery","filters":[],"threshold":{"field":["host.name","winlog.event_data.QueryName"],"value":50,"cardinality":[{"field":"winlog.event_data.ProcessId","value":5}]},"threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1110","name":"Brute Force","reference":"https://attack.mitre.org/techniques/T1110/"},{"id":"T1110.003","name":"Password Spraying","reference":"https://attack.mitre.org/techniques/T1110/003/"}]}],"tags":["APT","Credential Access","Password Spray","DNS","PowerShell"],"enabled":true,"interval":"10m","from":"now-30m","to":"now","actions":[],"author":["Threat Detection Team"],"license":"Elastic License v2","meta":{"from":"1m"},"max_signals":100}